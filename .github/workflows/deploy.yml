name: Deploy

on:
  # æ¨é€æ—¶æ‰§è¡Œ
  push:
    branches: [ master ]
  # å¯æ‰‹åŠ¨æ‰§è¡Œ
  workflow_dispatch:

jobs:
  deploy-server:
    runs-on: ubuntu-latest
    steps:
      # 1ã€æ£€å‡ºæºç 
      - name: Checkout
        uses: actions/checkout@v4
      # 2ã€å®‰è£… Java ç¯å¢ƒ
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "adopt"
          java-version: 17
          cache: "maven"
      # 3ã€æ‰“åŒ…
      - name: Build
        run: |
          sed -i.bak '/<repositories>/,/<\/repositories>/d' pom.xml
          sed -i.bak '/<pluginRepositories>/,/<\/pluginRepositories>/d' pom.xml
          mvn -B package --file pom.xml
      # 4ã€æ‹·è´åˆ°æœåŠ¡å™¨
      - name: Copy
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          source: ./continew-server/target/app/bin/continew-server.jar
          target: /www/jar
      #          strip_components: 3
      # 5ã€å¯åŠ¨
      - name: Start
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            echo "ğŸŸ¡ Step 1: åˆ‡æ¢ç›®å½•"
            cd /www/jar || { echo "âŒ åˆ‡æ¢ç›®å½•å¤±è´¥"; exit 1; }

            echo "ğŸŸ¡ Step 2: åœæ­¢æ—§è¿›ç¨‹"
            pkill -f 'continew-server.jar' || echo "ğŸ”¹ æ— æ—§è¿›ç¨‹"

            echo "ğŸŸ¡ Step 3: å¯åŠ¨æ–°æœåŠ¡"
            nohup java -jar continew-server.jar > app.log 2>&1 &

            sleep 5

            echo "ğŸŸ¡ Step 4: æ£€æŸ¥æ—¥å¿—è¾“å‡º"
            if [ -f app.log ]; then
              tail -n 20 app.log || echo "âš ï¸ æ—¥å¿—è¯»å–å¤±è´¥"
            else
              echo "âŒ æœªæ‰¾åˆ° app.log"
            fi

            echo "âœ… éƒ¨ç½²è„šæœ¬æ‰§è¡Œå®Œæ¯•"